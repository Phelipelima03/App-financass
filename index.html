<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MetaCart√£o ‚Äì MVP (HTML)</title>
  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121622;
      --panel2:#0f1320;
      --text:#e8eefc;
      --muted:#aab4d6;
      --line:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);

      --blue:#5bc0ff;
      --red:#ff5b5b;
      --green:#35d07f;
      --orange:#ffb347;
      --purple:#b58bff;
      --chip:#1a2032;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(91,192,255,.25), transparent 55%),
        radial-gradient(900px 500px at 85% 0%, rgba(181,139,255,.22), transparent 60%),
        linear-gradient(180deg, #070910, #0b0d12 40%, #080a10);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .app{ max-width: 1100px; margin: 0 auto; padding: 18px 14px 32px; }
    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom: 14px; }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(91,192,255,.95), rgba(181,139,255,.9));
      box-shadow: var(--shadow);
    }
    .brand h1{ margin:0; font-size: 16px; line-height:1.1; letter-spacing:.2px; }
    .brand .sub{ margin:2px 0 0; color:var(--muted); font-size: 12px; }
    .monthNav{
      display:flex; gap:10px; align-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .monthNav .m{ font-weight:700; letter-spacing:.4px; }

    .tabs{ display:grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap:10px; margin-bottom: 14px; }
    .tabBtn{
      border:0; border-radius: 16px; padding: 14px 12px;
      font-weight: 800; font-size: 15px; cursor:pointer;
      box-shadow: var(--shadow);
      color:#0b0d12;
      display:flex; align-items:center; justify-content:center; gap:8px;
      transition: transform .08s ease, filter .08s ease;
      user-select:none;
    }
    .tabBtn:active{ transform: scale(.99); filter: brightness(.98); }
    .tDash{ background: linear-gradient(135deg, rgba(91,192,255,1), rgba(91,192,255,.7)); }
    .tGastos{ background: linear-gradient(135deg, rgba(255,91,91,1), rgba(255,91,91,.7)); }
    .tFixas{ background: linear-gradient(135deg, rgba(53,208,127,1), rgba(53,208,127,.7)); }
    .tRec{ background: linear-gradient(135deg, rgba(255,179,71,1), rgba(255,179,71,.75)); }
    .tCards{ background: linear-gradient(135deg, rgba(181,139,255,1), rgba(181,139,255,.75)); }

    @media (max-width: 920px){
      .tabs{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .topbar{ flex-direction:column; align-items:stretch; gap:12px; }
      .monthNav{ justify-content:center; }
    }

    .panel{
      background: rgba(18,22,34,.86);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .panelTitle{ font-size: 15px; font-weight: 900; letter-spacing:.2px; margin:0; }
    .panelSub{ margin:2px 0 0; color: var(--muted); font-size: 12px; }
    .panelBody{ padding: 14px; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      border:0; border-radius: 14px; padding: 12px 14px;
      font-weight: 900; cursor:pointer; box-shadow: var(--shadow);
      user-select:none; display:inline-flex; align-items:center; gap:8px;
      justify-content:center; white-space:nowrap;
    }
    .btnSmall{ padding: 10px 12px; border-radius: 12px; font-weight: 800; }
    .btnGhost{ background: rgba(255,255,255,.06); color: var(--text); border: 1px solid var(--line); box-shadow:none; }
    .btnGreen{ background: linear-gradient(135deg, rgba(53,208,127,1), rgba(53,208,127,.78)); color:#08110a; }
    .btnOrange{ background: linear-gradient(135deg, rgba(255,179,71,1), rgba(255,179,71,.78)); color:#140b00; }
    .btnRed{ background: linear-gradient(135deg, rgba(255,91,91,1), rgba(255,91,91,.78)); color:#140404; }
    .btnDark{ background: rgba(10,12,18,.9); color: var(--text); border: 1px solid var(--line); box-shadow: none; }

    .kpi{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; }
    @media (max-width: 700px){ .kpi{ grid-template-columns: 1fr; } }
    .kpiCard{
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px 10px;
    }
    .kpiCard .label{ color: var(--muted); font-size: 12px; }
    .kpiCard .value{ font-size: 20px; font-weight: 950; margin-top:4px; letter-spacing:.2px; }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
    }
    .itemTop{ display:flex; gap:10px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; }
    .itemTitle{ font-weight: 950; font-size: 14px; margin:0; }
    .itemMeta{ margin:4px 0 0; color: var(--muted); font-size: 12px; line-height:1.35; }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px; border-radius: 999px;
      background: var(--chip);
      border: 1px solid var(--line);
      color: var(--text);
      font-size: 12px; font-weight: 900; white-space:nowrap;
    }
    .progressWrap{
      margin-top:10px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      height: 12px;
    }
    .progressBar{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(91,192,255,1), rgba(53,208,127,1));
    }
    .muted{ color: var(--muted); }
    .divider{ height:1px; background: var(--line); margin: 12px 0; }
    .mono{ font-variant-numeric: tabular-nums; }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 1000;
    }
    .modal{
      width: min(640px, 100%);
      background: rgba(18,22,34,.95);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: 0 30px 80px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .modalHeader{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modalHeader h3{ margin:0; font-size: 15px; font-weight: 950; }
    .modalBody{ padding: 14px; }
    .form{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 520px){ .form{ grid-template-columns: 1fr; } }
    label{ display:flex; flex-direction:column; gap:6px; font-size: 12px; color: var(--muted); font-weight: 800; }
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      font-size: 14px;
    }
    textarea{ min-height: 44px; resize: vertical; }
    .modalFooter{
      display:flex; gap:10px;
      justify-content:flex-end; align-items:center;
      padding: 12px 14px 14px;
      border-top: 1px solid var(--line);
      flex-wrap:wrap;
    }
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(10,12,18,.95);
      color: var(--text);
      border: 1px solid var(--line);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      display:none;
      z-index: 1100;
      font-weight: 800;
      font-size: 13px;
    }

    /* Chart */
    .chartWrap{
      margin-top: 10px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
    }
    canvas{ width:100%; height:180px; display:block; }
    .switchRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top: 8px; flex-wrap:wrap;
    }
    .switch{
      display:flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      font-size: 12px;
      font-weight: 900;
      color: var(--text);
      user-select:none;
    }
    .switch input{ width:16px; height:16px; margin:0; }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>MetaCart√£o</h1>
          <div class="sub">MVP (HTML) ‚Ä¢ dados salvos no navegador</div>
        </div>
      </div>

      <div class="monthNav">
        <button class="btn btnSmall btnGhost" id="btnPrev">‚óÄ</button>
        <div class="m mono" id="monthLabel">00/0000</div>
        <button class="btn btnSmall btnGhost" id="btnNext">‚ñ∂</button>
        <button class="btn btnSmall btnGhost" id="btnToday">Hoje</button>
        <button class="btn btnSmall btnGhost" id="btnExport">Exportar</button>
        <label class="btn btnSmall btnGhost" style="cursor:pointer;">
          Importar
          <input id="fileImport" type="file" accept="application/json" style="display:none;">
        </label>
        <button class="btn btnSmall btnGhost" id="btnReset">Reset</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tabBtn tDash" id="tabDashboard">üìä Dashboard</button>
      <button class="tabBtn tGastos" id="tabGastos">üßæ Gastos</button>
      <button class="tabBtn tFixas" id="tabFixas">üß© Fixas</button>
      <button class="tabBtn tRec" id="tabReceitas">üí∞ Receitas</button>
      <button class="tabBtn tCards" id="tabCartoes">üí≥ Cart√µes</button>
    </div>

    <div id="view"></div>
  </div>

  <!-- Modals -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHeader">
        <h3 id="modalTitle">Modal</h3>
        <button class="btn btnSmall btnGhost" id="modalClose">‚úï</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFooter" id="modalFooter"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  const STORAGE_KEY = "metacartao_data_v1";
  const NO_CARD = "Sem cart√£o";

  const DEFAULT_CARDS_LIMITS = {
    "Mercado Pago": 400,
    "Caixa": 400,
    "Magalu": 400,
    "BrB": 400,
    "Nubank": 0,
    "Inter": 0
  };

  const DEFAULT_INCOME_SOURCES = [
    "Sal√°rio 1","Sal√°rio 2","Hora besta","Vale terno","Rafa","Setis","Velinha","Velinho","Tia Mali","Renda extra"
  ];

  const DEFAULT_FIXED_TEMPLATES = [
    ["√Ågua", 380.00],
    ["Luz", 450.00],
    ["Internet", 33.33],
    ["G√°s", 120.00],
    ["Aluguel", 280.00],
    ["Celular Pi", 50.00],
    ["Celular Mari", 75.00],
    ["Rafael", 190.00],
    ["Ajuda Velhinhos", 410.00],
    ["Empr√©stimo MP", 404.62],
    ["Velhinho consignado", 222.00],
    ["Passagem", 242.00],
    ["Cart√£o Mercado Pago", 400.00],
    ["Cart√£o Caixa", 400.00],
    ["Cart√£o Magazine Luiza", 400.00],
    ["Cart√£o BrB", 400.00],
  ];

  function seed(){
    return {
      categories: { META: { "Alimenta√ß√£o": 900.0 } },
      expense_categories: ["Alimenta√ß√£o","Despesas Fixas","Outros"],
      cards: { ...DEFAULT_CARDS_LIMITS },
      fixed_templates: DEFAULT_FIXED_TEMPLATES.map(([name, amount]) => ({ name, amount })),
      incomes: [],
      income_sources: [...DEFAULT_INCOME_SOURCES],
      transactions: [],
      month_plans: {} // {"MM/YYYY": { income_expected: number }}
    };
  }

  function safeText(x){ try { return String(x ?? ""); } catch { return ""; } }
  function numOr(v, fallback){
    const n = Number(String(v).replace(/\./g,"").replace(",","."));
    return Number.isFinite(n) ? n : fallback;
  }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function brl(v){
    const vv = Number(v || 0);
    return vv.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
  }
  function today(){
    const d = new Date();
    d.setHours(0,0,0,0);
    return d;
  }
  function fmt_ddmmyyyy(d){
    return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
  }
  function parse_ddmmyyyy(s){
    const t = String(s || "").trim();
    const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(t);
    if (!m) return null;
    const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
    const d = new Date(yy, mm-1, dd);
    if (d.getFullYear() !== yy || (d.getMonth()+1) !== mm || d.getDate() !== dd) return null;
    d.setHours(0,0,0,0);
    return d;
  }
  function monthYearStr(m, y){ return `${pad2(m)}/${y}`; }
  function addMonths(d, n){
    const nd = new Date(d);
    const day = nd.getDate();
    nd.setDate(1);
    nd.setMonth(nd.getMonth() + n);
    const last = new Date(nd.getFullYear(), nd.getMonth()+1, 0).getDate();
    nd.setDate(Math.min(day, last));
    nd.setHours(0,0,0,0);
    return nd;
  }
  function sameMonth(d, m, y){ return d.getMonth()+1 === m && d.getFullYear() === y; }

  // ====== NORMALIZA√á√ÉO FORTE ======
  function normCategory(cat){
    const c = safeText(cat).trim();
    const low = c.toLowerCase();

    if (low === "despesas fixas" || low === "despesa fixa" || low === "fixas") return "Despesas Fixas";
    if (low === "alimentacao" || low === "alimenta√ß√£o") return "Alimenta√ß√£o";
    if (low === "outros" || low === "outro") return "Outros";

    return c || "Outros";
  }
  function normDesc(s){ return safeText(s).trim().replace(/\s+/g, " "); }
  function startsWithNorm(hay, needle){
    const h = normDesc(hay).toLowerCase();
    const n = normDesc(needle).toLowerCase();
    return h.startsWith(n);
  }

  function parseInstallments(text){
    const t = String(text || "").trim();
    if (!t || !t.includes("/")) return [null, null];
    const parts = t.split("/");
    if (parts.length !== 2) return [null, null];
    const idx = Number(parts[0].trim());
    const tot = Number(parts[1].trim());
    if (!Number.isInteger(idx) || !Number.isInteger(tot)) return [null, null];
    if (tot <= 0 || idx <= 0 || idx > tot) return [null, null];
    return [idx, tot];
  }
  function splitInstallmentValues(total, tot){
    const base = Math.round((total / tot) * 100) / 100;
    const vals = Array(tot).fill(base);
    const last = Math.round((total - base * (tot - 1)) * 100) / 100;
    vals[tot - 1] = last;
    return vals;
  }

  function normalizeData(d){
    if (!d || typeof d !== "object") d = {};
    if (!d.categories || typeof d.categories !== "object") d.categories = { META: {} };
    if (!d.categories.META || typeof d.categories.META !== "object") d.categories.META = {};
    if (!("Alimenta√ß√£o" in d.categories.META)) d.categories.META["Alimenta√ß√£o"] = 900.0;
    d.categories.META["Alimenta√ß√£o"] = numOr(d.categories.META["Alimenta√ß√£o"], 900.0);

    if (!Array.isArray(d.expense_categories)) d.expense_categories = ["Alimenta√ß√£o","Despesas Fixas","Outros"];

    d.expense_categories = d.expense_categories.map(normCategory);
    for (const base of ["Alimenta√ß√£o","Despesas Fixas","Outros"]){
      if (!d.expense_categories.includes(base)) d.expense_categories.push(base);
    }
    for (const catName of Object.keys(d.categories.META)){
      const cc = normCategory(catName);
      if (!d.expense_categories.includes(cc)) d.expense_categories.unshift(cc);
      if (cc !== catName){
        d.categories.META[cc] = d.categories.META[catName];
        delete d.categories.META[catName];
      }
    }

    if (!d.cards || typeof d.cards !== "object" || Array.isArray(d.cards)) d.cards = {};
    for (const [k,v] of Object.entries(DEFAULT_CARDS_LIMITS)){
      if (!(k in d.cards)) d.cards[k] = v;
      d.cards[k] = numOr(d.cards[k], v);
    }

    if (!Array.isArray(d.fixed_templates)) d.fixed_templates = DEFAULT_FIXED_TEMPLATES.map(([name, amount]) => ({ name, amount }));
    d.fixed_templates = d.fixed_templates
      .map(it => {
        if (!it || typeof it !== "object") return null;
        const name = normDesc(it.name);
        if (!name) return null;
        const amount = numOr(it.amount, 0);
        return { name, amount };
      })
      .filter(Boolean);

    if (!Array.isArray(d.income_sources) || !d.income_sources.length) d.income_sources = [...DEFAULT_INCOME_SOURCES];

    if (!Array.isArray(d.incomes)) d.incomes = [];
    d.incomes = d.incomes
      .map(it => {
        if (!it || typeof it !== "object") return null;
        const date = safeText(it.date || it.data || fmt_ddmmyyyy(today())).trim();
        const valor = numOr(it.valor ?? it.amount, 0);
        const source = normDesc(it.source || it.origem || it.nome || "Receita");
        const desc = normDesc(it.desc || it.descricao || "");
        return { date, valor, source, desc };
      })
      .filter(Boolean);

    if (!Array.isArray(d.transactions)) d.transactions = [];
    d.transactions = d.transactions
      .map(t => {
        if (!t || typeof t !== "object") return null;

        const date = safeText(t.date || t.data || fmt_ddmmyyyy(today())).trim();
        const valor = numOr(t.valor, 0);

        const cat = normCategory(t.cat || t.categoria || "Outros");
        const card = normDesc(t.card || t.cartao || "");
        const desc = normDesc(t.desc || t.descricao || "");

        const paid = t.paid === true || t.pago === true;

        let fixed_template = t.fixed_template ? normDesc(t.fixed_template) : "";
        if (cat === "Despesas Fixas" && !fixed_template){
          for (const ft of (d.fixed_templates || [])){
            if (startsWithNorm(desc, ft.name)){
              fixed_template = ft.name;
              break;
            }
          }
        }

        if (!d.expense_categories.includes(cat)) d.expense_categories.push(cat);

        return { date, valor, cat, card, desc, paid, fixed_template };
      })
      .filter(Boolean);

    if (!d.month_plans || typeof d.month_plans !== "object" || Array.isArray(d.month_plans)) d.month_plans = {};
    return d;
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return normalizeData(seed());
      return normalizeData(JSON.parse(raw));
    }catch{
      return normalizeData(seed());
    }
  }
  function save(){
    data = normalizeData(data);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  // ====== Totais (APENAS m√™s selecionado) ======
  function monthTotalExpenses(m, y){
    return data.transactions.reduce((acc, t) => {
      const d = parse_ddmmyyyy(t.date);
      if (!d) return acc;
      if (sameMonth(d, m, y)) acc += Number(t.valor || 0);
      return acc;
    }, 0);
  }
  function monthTotalIncomes(m, y){
    return data.incomes.reduce((acc, it) => {
      const d = parse_ddmmyyyy(it.date);
      if (!d) return acc;
      if (sameMonth(d, m, y)) acc += Number(it.valor || 0);
      return acc;
    }, 0);
  }
  function monthTotalForCard(card, m, y){
    return data.transactions.reduce((acc, t) => {
      if (t.cat === "Despesas Fixas") return acc;
      if (t.card !== card) return acc;
      const d = parse_ddmmyyyy(t.date);
      if (!d) return acc;
      if (sameMonth(d, m, y)) acc += Number(t.valor || 0);
      return acc;
    }, 0);
  }

  function monthTransactions(m, y){
    const txs = data.transactions.filter(t => {
      const d = parse_ddmmyyyy(t.date);
      if (!d) return false;
      return sameMonth(d, m, y);
    });
    txs.reverse();
    return txs;
  }
  function monthTransactionsForCard(card, m, y){
    const txs = data.transactions.filter(t => {
      if (t.cat === "Despesas Fixas") return false;
      if (t.card !== card) return false;
      const d = parse_ddmmyyyy(t.date);
      if (!d) return false;
      return sameMonth(d, m, y);
    });
    txs.reverse();
    return txs;
  }

  // ====== Fixas: N√ÉO DUPLICAR (usa fixed_template como chave) ======
  function ensureFixedDueForMonth(m, y){
    const templates = Array.isArray(data.fixed_templates) ? data.fixed_templates : [];
    if (!templates.length) return;

    for (const it of templates){
      const nm = normDesc(it.name);
      const amt = numOr(it.amount, 0);

      const exists = data.transactions.some(t => {
        const d = parse_ddmmyyyy(t.date);
        if (!d) return false;
        if (!sameMonth(d, m, y)) return false;
        if (t.cat !== "Despesas Fixas") return false;

        if (t.fixed_template && startsWithNorm(t.fixed_template, nm)) return true;
        return startsWithNorm(t.desc, nm);
      });

      if (!exists){
        data.transactions.push({
          date: `01/${pad2(m)}/${y}`,
          valor: Number(amt),
          cat: "Despesas Fixas",
          card: NO_CARD,
          desc: nm,
          paid: false,
          fixed_template: nm
        });
      }
    }
  }

  // ====== Previsto x Realizado ======
  function monthExpectedIncome(m, y){
    const key = monthYearStr(m, y);
    const mp = data.month_plans && data.month_plans[key];
    if (!mp) return 0;
    return numOr(mp.income_expected, 0);
  }
  function setMonthExpectedIncome(m, y, v){
    const key = monthYearStr(m, y);
    if (!data.month_plans) data.month_plans = {};
    if (!data.month_plans[key]) data.month_plans[key] = {};
    data.month_plans[key].income_expected = Number(v || 0);
    save();
  }
  function monthExpectedExpenses(){
    const fixed = (data.fixed_templates || []).reduce((acc, it) => acc + numOr(it.amount, 0), 0);
    const meta = (data.categories && data.categories.META) ? data.categories.META : {};
    const metas = Object.values(meta).reduce((acc, v) => acc + numOr(v, 0), 0);
    return fixed + metas;
  }

  // ====== UI helpers ======
  const view = document.getElementById("view");
  const monthLabel = document.getElementById("monthLabel");
  const modalOverlay = document.getElementById("modalOverlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  const modalFooter = document.getElementById("modalFooter");
  const modalClose = document.getElementById("modalClose");
  const toastEl = document.getElementById("toast");

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(() => toastEl.style.display = "none", 2200);
  }
  function openModal(title, bodyNode, footerButtons){
    modalTitle.textContent = title;
    modalBody.innerHTML = "";
    modalBody.appendChild(bodyNode);
    modalFooter.innerHTML = "";
    for (const btn of footerButtons) modalFooter.appendChild(btn);
    modalOverlay.style.display = "flex";
  }
  function closeModal(){ modalOverlay.style.display = "none"; }

  modalClose.addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) closeModal(); });
  window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

  function el(tag, attrs={}, children=[]){
    const n = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)){
      if (k === "class") n.className = v;
      else if (k === "html") n.innerHTML = v;
      else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
      else if (v == null) {}
      else n.setAttribute(k, v);
    }
    for (const c of children){
      if (c == null) continue;
      if (typeof c === "string") n.appendChild(document.createTextNode(c));
      else n.appendChild(c);
    }
    return n;
  }
  function btnSmall(text, cls, onClick){ return el("button", { class: `btn btnSmall ${cls||""}`, onclick: onClick }, [text]); }
  function select(options, value){
    const s = el("select");
    for (const opt of options) s.appendChild(el("option", { value: opt }, [opt]));
    s.value = value;
    return s;
  }

  // ====== App state ======
  let data = load();
  const now = today();
  const state = { m: now.getMonth()+1, y: now.getFullYear(), route: "dashboard", cardDetail: null, showPlannedOnChart: true };

  function setMonth(m, y){
    state.m = m; state.y = y;
    monthLabel.textContent = monthYearStr(state.m, state.y);
    ensureFixedDueForMonth(state.m, state.y);
    save();
    render();
  }
  function go(route, payload=null){
    state.route = route;
    state.cardDetail = payload;
    render();
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `metacartao_${monthYearStr(state.m, state.y).replace("/","-")}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  function importJSONFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(String(reader.result || "{}"));
        data = normalizeData(obj);
        ensureFixedDueForMonth(state.m, state.y);
        save();
        toast("Importado com sucesso.");
        render();
      }catch{
        toast("Arquivo inv√°lido.");
      }
    };
    reader.readAsText(file);
  }

  // ====== Header buttons ======
  document.getElementById("btnPrev").addEventListener("click", () => {
    const d = new Date(state.y, state.m-1, 1);
    const nd = addMonths(d, -1);
    setMonth(nd.getMonth()+1, nd.getFullYear());
  });
  document.getElementById("btnNext").addEventListener("click", () => {
    const d = new Date(state.y, state.m-1, 1);
    const nd = addMonths(d, +1);
    setMonth(nd.getMonth()+1, nd.getFullYear());
  });
  document.getElementById("btnToday").addEventListener("click", () => {
    const t = today();
    setMonth(t.getMonth()+1, t.getFullYear());
  });
  document.getElementById("btnExport").addEventListener("click", exportJSON);
  document.getElementById("btnReset").addEventListener("click", () => {
    if (!confirm("Resetar todos os dados?")) return;
    data = normalizeData(seed());
    ensureFixedDueForMonth(state.m, state.y);
    save();
    toast("Dados resetados.");
    render();
  });
  document.getElementById("fileImport").addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    e.target.value = "";
    if (file) importJSONFile(file);
  });

  // ====== Tabs ======
  document.getElementById("tabDashboard").addEventListener("click", () => go("dashboard"));
  document.getElementById("tabGastos").addEventListener("click", () => go("gastos"));
  document.getElementById("tabFixas").addEventListener("click", () => go("fixas"));
  document.getElementById("tabReceitas").addEventListener("click", () => go("receitas"));
  document.getElementById("tabCartoes").addEventListener("click", () => go("cartoes"));

  // ====== Popups (iguais) ======
  function popupAddTransaction(goBack="dashboard", prefillCard=null){
    const wrap = el("div");
    const form = el("div", { class:"form" });

    const iDate = el("input", { value: fmt_ddmmyyyy(today()), placeholder:"dd/MM/aaaa" });
    const iDesc = el("input", { placeholder:"Descri√ß√£o" });
    const iVal  = el("input", { placeholder:"Valor total (ex: 1000,00)" });
    const iParc = el("input", { placeholder:"Parcelas opcional (ex: 1/10)" });

    const cats = Array.isArray(data.expense_categories) && data.expense_categories.length
      ? data.expense_categories
      : ["Outros"];
    const sCat = select(cats, cats[0]);

    const cardNames = Object.keys(data.cards || {});
    if (!cardNames.length){ data.cards = { "Mercado Pago": 0 }; cardNames.push("Mercado Pago"); }
    const sCard = select(cardNames, prefillCard && cardNames.includes(prefillCard) ? prefillCard : cardNames[0]);

    const cardLabel = el("div", { class:"muted", style:"font-size:12px; font-weight:800; margin-top:6px; display:none;" }, [
      "Despesas Fixas usam: ", NO_CARD
    ]);

    function syncCat(){
      if (sCat.value === "Despesas Fixas"){
        sCard.style.display = "none";
        cardLabel.style.display = "block";
      }else{
        sCard.style.display = "";
        cardLabel.style.display = "none";
      }
    }
    sCat.addEventListener("change", syncCat);

    form.appendChild(el("label", {}, ["Data", iDate]));
    form.appendChild(el("label", {}, ["Descri√ß√£o", iDesc]));
    form.appendChild(el("label", {}, ["Valor total", iVal]));
    form.appendChild(el("label", {}, ["Parcelas (opcional)", iParc]));
    form.appendChild(el("label", {}, ["Categoria", sCat]));
    form.appendChild(el("label", {}, ["Cart√£o", sCard, cardLabel]));

    wrap.appendChild(form);
    syncCat();

    const bCancel = btnSmall("Cancelar", "btnGhost", () => closeModal());
    const bSave = btnSmall("Salvar", "btnGreen", () => {
      const d = parse_ddmmyyyy(iDate.value);
      if (!d){ toast("Data inv√°lida. Use dd/MM/aaaa."); return; }

      const total = numOr(iVal.value, NaN);
      const desc = normDesc(iDesc.value || "");
      const cat = normCategory(sCat.value);
      const card = (cat === "Despesas Fixas") ? NO_CARD : normDesc(sCard.value);

      if (!Number.isFinite(total) || !desc){ toast("Preencha valor e descri√ß√£o."); return; }

      const [idx, tot] = parseInstallments(iParc.value);

      if (tot == null){
        data.transactions.push({ date: fmt_ddmmyyyy(d), valor: Number(total), cat, card, desc, paid: false, fixed_template: "" });
      }else{
        const vals = splitInstallmentValues(Number(total), tot);
        const startIndex = idx;
        const remaining = tot - startIndex + 1;

        for (let i=0; i<remaining; i++){
          const parcelaNum = startIndex + i;
          const dd = addMonths(d, i);
          data.transactions.push({
            date: fmt_ddmmyyyy(dd),
            valor: Number(vals[parcelaNum - 1]),
            cat, card,
            desc: `${desc} (${parcelaNum}/${tot})`,
            paid: false,
            fixed_template: ""
          });
        }
      }

      save();
      closeModal();
      if (goBack === "card_detail") go("card_detail", prefillCard);
      else go(goBack);
      toast("Gasto salvo.");
    });

    openModal("Novo gasto", wrap, [bCancel, bSave]);
  }

  function popupAddIncome(goBack="dashboard"){
    const wrap = el("div");
    const form = el("div", { class:"form" });

    const iDate = el("input", { value: fmt_ddmmyyyy(today()), placeholder:"dd/MM/aaaa" });
    const sources = Array.isArray(data.income_sources) && data.income_sources.length ? data.income_sources : ["Sal√°rio 1"];
    const sSrc = select(sources, sources[0]);
    const iVal = el("input", { placeholder:"Valor (ex: 2500,00)" });
    const iDesc = el("input", { placeholder:"Observa√ß√£o (opcional)" });

    form.appendChild(el("label", {}, ["Data", iDate]));
    form.appendChild(el("label", {}, ["Fonte", sSrc]));
    form.appendChild(el("label", {}, ["Valor", iVal]));
    form.appendChild(el("label", {}, ["Obs (opcional)", iDesc]));
    wrap.appendChild(form);

    const bCancel = btnSmall("Cancelar", "btnGhost", () => closeModal());
    const bSave = btnSmall("Salvar", "btnOrange", () => {
      const d = parse_ddmmyyyy(iDate.value);
      if (!d){ toast("Data inv√°lida. Use dd/MM/aaaa."); return; }
      const v = numOr(iVal.value, NaN);
      if (!Number.isFinite(v)){ toast("Preencha o valor."); return; }

      data.incomes.push({ date: fmt_ddmmyyyy(d), valor: Number(v), source: normDesc(sSrc.value), desc: normDesc(iDesc.value || "") });
      save();
      closeModal();
      go(goBack);
      toast("Receita salva.");
    });

    openModal("Nova receita", wrap, [bCancel, bSave]);
  }

  function popupEditPlan(){
    const wrap = el("div");
    const form = el("div", { class:"form" });

    const key = monthYearStr(state.m, state.y);
    const cur = monthExpectedIncome(state.m, state.y);
    const iIncomeExp = el("input", { value: String(cur || ""), placeholder:"Receitas previstas do m√™s (ex: 3500,00)" });
    const expExpenses = monthExpectedExpenses();

    const hint = el("div", { class:"item", style:"grid-column:1/-1;" }, [
      el("div", { class:"itemTitle" }, ["Como o Previsto funciona"]),
      el("div", { class:"itemMeta" }, [
        "‚Ä¢ Despesas previstas = Fixas (lista) + Metas (categorias).", el("br"),
        "‚Ä¢ Receitas previstas = valor que voc√™ define aqui.", el("br"),
        "‚Ä¢ Cart√µes: limite/meta do cart√£o √© o previsto do cart√£o."
      ])
    ]);

    form.appendChild(el("label", {}, ["Receitas previstas", iIncomeExp]));
    form.appendChild(el("label", {}, ["Despesas previstas (auto)", el("input", { value: brl(expExpenses), disabled:"true" })]));
    form.appendChild(hint);
    wrap.appendChild(form);

    const bCancel = btnSmall("Cancelar", "btnGhost", () => closeModal());
    const bSave = btnSmall("Salvar", "btnGreen", () => {
      const v = numOr(iIncomeExp.value, NaN);
      if (!Number.isFinite(v)){ toast("Preencha as receitas previstas."); return; }
      setMonthExpectedIncome(state.m, state.y, v);
      closeModal();
      toast("Planejamento salvo.");
      render();
    });

    openModal(`Planejamento ‚Ä¢ ${key}`, wrap, [bCancel, bSave]);
  }

  function popupEditCard(cardName){
    const wrap = el("div");
    const form = el("div", { class:"form" });

    const iName = el("input", { value: cardName, placeholder:"Nome do cart√£o" });
    const iLimit = el("input", { value: String(numOr((data.cards||{})[cardName], 0)), placeholder:"Limite/meta do m√™s (ex: 400,00)" });

    form.appendChild(el("label", {}, ["Nome", iName]));
    form.appendChild(el("label", {}, ["Limite/meta do m√™s", iLimit]));
    wrap.appendChild(form);

    const bCancel = btnSmall("Cancelar", "btnGhost", () => closeModal());

    const bDelete = btnSmall("Excluir", "btnRed", () => {
      if (!confirm("Excluir este cart√£o?")) return;

      delete data.cards[cardName];
      data.transactions = (data.transactions || []).map(t => (t.card === cardName ? { ...t, card: "" } : t));

      save();
      closeModal();
      toast("Cart√£o exclu√≠do.");
      if (state.route === "card_detail") go("cartoes"); else render();
    });

    const bSave = btnSmall("Salvar", "btnGreen", () => {
      const newName = normDesc(iName.value);
      const newLimit = numOr(iLimit.value, NaN);
      if (!newName || !Number.isFinite(newLimit)){ toast("Preencha nome e limite."); return; }

      if (newName !== cardName){
        if (data.cards[newName] != null){ toast("J√° existe um cart√£o com esse nome."); return; }
        delete data.cards[cardName];
        data.cards[newName] = Number(newLimit);

        data.transactions = (data.transactions || []).map(t => (t.card === cardName ? { ...t, card: newName } : t));

        save();
        closeModal();
        toast("Cart√£o atualizado.");
        if (state.route === "card_detail") go("card_detail", newName); else render();
      }else{
        data.cards[cardName] = Number(newLimit);
        save();
        closeModal();
        toast("Cart√£o atualizado.");
        render();
      }
    });

    openModal("Editar cart√£o", wrap, [bCancel, bDelete, bSave]);
  }

  function popupAddCard(){
    const wrap = el("div");
    const form = el("div", { class:"form" });

    const iName = el("input", { placeholder:"Nome do cart√£o (ex: Ita√∫)" });
    const iLimit = el("input", { placeholder:"Limite/meta do m√™s (ex: 500,00)" });

    form.appendChild(el("label", {}, ["Nome", iName]));
    form.appendChild(el("label", {}, ["Limite/meta do m√™s", iLimit]));
    wrap.appendChild(form);

    const bCancel = btnSmall("Cancelar", "btnGhost", () => closeModal());
    const bSave = btnSmall("Adicionar", "btnGreen", () => {
      const nm = normDesc(iName.value);
      const v = numOr(iLimit.value, NaN);
      if (!nm || !Number.isFinite(v)){ toast("Preencha nome e limite."); return; }
      if (data.cards[nm] != null){ toast("Esse cart√£o j√° existe."); return; }

      data.cards[nm] = Number(v);
      save();
      closeModal();
      toast("Cart√£o adicionado.");
      render();
    });

    openModal("Novo cart√£o", wrap, [bCancel, bSave]);
  }

  // ====== Gr√°fico: SOMENTE do m√™s selecionado (remove linha/escala de 6 meses) ======
  function buildSeriesForSelectedMonth(){
    const m = state.m, y = state.y;

    const incR = monthTotalIncomes(m,y);
    const expR = monthTotalExpenses(m,y);
    const saldoR = incR - expR;

    const incP = monthExpectedIncome(m,y);
    const expP = monthExpectedExpenses();
    const saldoP = incP - expP;

    return [{
      label: `${pad2(m)}/${String(y).slice(-2)}`,
      incomesR: incR, expensesR: expR, saldoR,
      incomesP: incP, expensesP: expP, saldoP
    }];
  }

  function drawMonthlyChart(canvas, point, showPlanned){
    const ctx = canvas.getContext("2d");
    const dpr = (window.devicePixelRatio || 1);
    const w = canvas.width = Math.floor(canvas.clientWidth * dpr);
    const h = canvas.height = Math.floor(canvas.clientHeight * dpr);
    ctx.clearRect(0,0,w,h);

    const pad = 16 * dpr;
    const x0 = pad, y0 = pad + 10*dpr;
    const x1 = w - pad, y1 = h - pad - 10*dpr;

    // base line
    ctx.lineWidth = 1*dpr;
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.beginPath();
    ctx.moveTo(x0, y1);
    ctx.lineTo(x1, y1);
    ctx.stroke();

    const maxAbs = Math.max(
      1,
      point.incomesR, point.expensesR, Math.abs(point.saldoR),
      showPlanned ? Math.max(point.incomesP, point.expensesP, Math.abs(point.saldoP)) : 1
    );

    function yFromVal(v){
      const t = v / maxAbs;
      return y1 - (y1 - y0) * t;
    }

    const cx = (x0 + x1) / 2;
    const barW = Math.max(18*dpr, Math.min(34*dpr, (x1-x0)*0.06));

    const cA = "rgba(255,255,255,.55)"; // receitas realizado
    const cB = "rgba(255,255,255,.35)"; // despesas realizado
    const cC = "rgba(255,255,255,.75)"; // saldo realizado

    // Receitas (Realizado)
    let yInc = yFromVal(point.incomesR);
    ctx.fillStyle = cA;
    ctx.fillRect(cx - barW*2.0, yInc, barW, y1 - yInc);

    // Despesas (Realizado)
    let yExp = yFromVal(point.expensesR);
    ctx.fillStyle = cB;
    ctx.fillRect(cx - barW*0.5, yExp, barW, y1 - yExp);

    // Saldo (Realizado)
    const zeroY = yFromVal(0);
    ctx.fillStyle = cC;
    if (point.saldoR >= 0){
      const yS = yFromVal(point.saldoR);
      ctx.fillRect(cx + barW*1.0, yS, barW, zeroY - yS);
    }else{
      const down = (y1 - y0) * (Math.abs(point.saldoR) / maxAbs);
      ctx.fillRect(cx + barW*1.0, zeroY, barW, down);
    }

    // Previsto (linha tracejada) - agora s√≥ no m√™s selecionado
    if (showPlanned){
      ctx.strokeStyle = "rgba(255,255,255,.55)";
      ctx.lineWidth = 2*dpr;
      ctx.setLineDash([6*dpr, 6*dpr]);
      ctx.beginPath();
      const y = yFromVal(Math.max(0, point.saldoP));
      ctx.moveTo(x0, y);
      ctx.lineTo(x1, y);
      ctx.stroke();
      ctx.setLineDash([]);
    }

    // legend top
    ctx.fillStyle = "rgba(255,255,255,.65)";
    ctx.font = `${12*dpr}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.textAlign = "left";
    ctx.fillText(`M√™s ${monthYearStr(state.m, state.y)} ‚Ä¢ Realizado: Receitas | Despesas | Saldo`, x0, y0 - 4*dpr);
    if (showPlanned) ctx.fillText("Previsto: linha tracejada (Saldo)", x0, y0 + 14*dpr);
  }

  // ====== Views ======
  function render(){
    ensureFixedDueForMonth(state.m, state.y);
    save();

    monthLabel.textContent = monthYearStr(state.m, state.y);
    view.innerHTML = "";

    if (state.route === "dashboard") view.appendChild(renderDashboard());
    else if (state.route === "gastos") view.appendChild(renderGastos());
    else if (state.route === "fixas") view.appendChild(renderFixas());
    else if (state.route === "receitas") view.appendChild(renderReceitas());
    else if (state.route === "cartoes") view.appendChild(renderCartoes());
    else if (state.route === "card_detail") view.appendChild(renderCardDetail(state.cardDetail));
    else view.appendChild(renderDashboard());

    window.removeEventListener("resize", window._mc_resize);
    window._mc_resize = () => {
      const c = document.getElementById("monthlyChart");
      if (!c) return;
      const pt = buildSeriesForSelectedMonth()[0];
      drawMonthlyChart(c, pt, state.showPlannedOnChart);
    };
    window.addEventListener("resize", window._mc_resize);
  }

  // ====== Dashboard (somente m√™s selecionado + gr√°fico do m√™s) ======
  function renderDashboard(){
    const p = el("div", { class:"panel" });

    p.appendChild(
      el("div", { class:"panelHeader" }, [
        el("div", {}, [
          el("div", { class:"panelTitle" }, ["üìä Dashboard ‚Ä¢ ", monthYearStr(state.m, state.y)]),
          el("div", { class:"panelSub" }, ["Somente m√™s selecionado ‚Ä¢ Previsto x Realizado ‚Ä¢ gr√°fico do m√™s"])
        ]),
        el("div", { class:"row" }, [
          btnSmall("+ Gasto", "btnGreen", () => popupAddTransaction("dashboard")),
          btnSmall("+ Receita", "btnOrange", () => popupAddIncome("dashboard")),
          btnSmall("Planejar", "btnGhost", () => popupEditPlan()),
        ])
      ])
    );

    const incR = monthTotalIncomes(state.m, state.y);
    const expR = monthTotalExpenses(state.m, state.y);
    const saldoR = incR - expR;

    const expP = monthExpectedExpenses();
    const incP = monthExpectedIncome(state.m, state.y);
    const saldoP = incP - expP;

    const body = el("div", { class:"panelBody" });

    body.appendChild(el("div", { class:"itemTitle" }, ["Realizado (m√™s selecionado)"]));
    body.appendChild(el("div", { class:"kpi" }, [
      el("div", { class:"kpiCard" }, [
        el("div", { class:"label" }, ["Receitas"]),
        el("div", { class:"value mono" }, [brl(incR)])
      ]),
      el("div", { class:"kpiCard" }, [
        el("div", { class:"label" }, ["Despesas"]),
        el("div", { class:"value mono" }, [brl(expR)])
      ]),
      el("div", { class:"kpiCard" }, [
        el("div", { class:"label" }, ["Saldo"]),
        el("div", { class:"value mono" }, [brl(saldoR)])
      ]),
    ]));

    body.appendChild(el("div", { class:"divider" }));

    body.appendChild(el("div", { class:"itemTitle" }, ["Previsto (m√™s selecionado)"]));
    body.appendChild(el("div", { class:"kpi" }, [
      el("div", { class:"kpiCard" }, [
        el("div", { class:"label" }, ["Receitas previstas"]),
        el("div", { class:"value mono" }, [brl(incP)])
      ]),
      el("div", { class:"kpiCard" }, [
        el("div", { class:"label" }, ["Despesas previstas"]),
        el("div", { class:"value mono" }, [brl(expP)])
      ]),
      el("div", { class:"kpiCard" }, [
        el("div", { class:"label" }, ["Saldo previsto"]),
        el("div", { class:"value mono" }, [brl(saldoP)])
      ]),
    ]));

    const chartBox = el("div", { class:"chartWrap" }, [
      el("div", { class:"itemTitle" }, ["Gr√°fico do m√™s (selecionado)"]),
      el("div", { class:"itemMeta" }, ["Barras = Realizado ‚Ä¢ Linha tracejada = Saldo Previsto (opcional)"]),
      el("canvas", { id:"monthlyChart" }),
      el("div", { class:"switchRow" }, [
        el("div", { class:"switch" }, [
          el("input", { type:"checkbox", id:"chkPlanned", checked: state.showPlannedOnChart ? "true" : null }),
          el("label", { for:"chkPlanned", style:"cursor:pointer;" }, ["Mostrar previsto no gr√°fico"])
        ]),
        btnSmall("Planejar m√™s", "btnGhost", () => popupEditPlan()),
      ])
    ]);

    body.appendChild(el("div", { class:"divider" }));
    body.appendChild(chartBox);

    p.appendChild(body);

    setTimeout(() => {
      const c = document.getElementById("monthlyChart");
      if (c){
        const pt = buildSeriesForSelectedMonth()[0];
        drawMonthlyChart(c, pt, state.showPlannedOnChart);
      }

      const chk = document.getElementById("chkPlanned");
      if (chk){
        chk.checked = !!state.showPlannedOnChart;
        chk.addEventListener("change", () => {
          state.showPlannedOnChart = chk.checked;
          const c2 = document.getElementById("monthlyChart");
          if (c2){
            const pt2 = buildSeriesForSelectedMonth()[0];
            drawMonthlyChart(c2, pt2, state.showPlannedOnChart);
          }
        });
      }
    }, 0);

    return p;
  }

  // ====== Demais telas (iguais da sua vers√£o anterior) ======
  function renderGastos(){
    const p = el("div", { class:"panel" });

    p.appendChild(
      el("div", { class:"panelHeader" }, [
        el("div", {}, [
          el("div", { class:"panelTitle" }, ["üßæ Gastos ‚Ä¢ ", monthYearStr(state.m, state.y)]),
          el("div", { class:"panelSub" }, ["Pago/N√£o pago ‚Ä¢ somente m√™s selecionado"])
        ]),
        btnSmall("+ Novo", "btnGreen", () => popupAddTransaction("gastos"))
      ])
    );

    const body = el("div", { class:"panelBody" });
    const txs = monthTransactions(state.m, state.y);

    if (!txs.length){
      body.appendChild(el("div", { class:"item" }, [el("div", { class:"muted" }, ["Sem gastos neste m√™s."])]));
      p.appendChild(body);
      return p;
    }

    const list = el("div", { class:"list" });

    txs.forEach((t) => {
      const paid = t.paid === true;
      const paidTxt = paid ? "‚úÖ Pago" : "‚¨úÔ∏è Pagar";
      const cardShow = (t.cat === "Despesas Fixas" || t.card === NO_CARD || !t.card) ? "‚Äî" : t.card;

      const item = el("div", { class:"item" });
      item.appendChild(el("div", { class:"itemTop" }, [
        el("div", {}, [
          el("p", { class:"itemTitle mono" }, [`${t.date} ‚Ä¢ ${t.cat} ‚Ä¢ ${cardShow} ‚Ä¢ ${brl(t.valor)}`]),
          el("div", { class:"itemMeta" }, [safeText(t.desc || "")])
        ]),
        el("div", { class:"row" }, [
          btnSmall(paidTxt, paid ? "btnDark" : "btnGhost", () => { t.paid = !paid; save(); render(); }),
          btnSmall("Excluir", "btnRed", () => {
            if (!confirm("Excluir este gasto?")) return;
            const idx = data.transactions.indexOf(t);
            if (idx >= 0) data.transactions.splice(idx, 1);
            save();
            toast("Gasto exclu√≠do.");
            render();
          })
        ])
      ]));
      list.appendChild(item);
    });

    body.appendChild(list);
    p.appendChild(body);
    return p;
  }

  function renderFixas(){
    const p = el("div", { class:"panel" });

    p.appendChild(
      el("div", { class:"panelHeader" }, [
        el("div", {}, [
          el("div", { class:"panelTitle" }, ["üß© Fixas ‚Ä¢ ", monthYearStr(state.m, state.y)]),
          el("div", { class:"panelSub" }, ["Modelos + fixas do m√™s (sem duplicar)"])
        ]),
        el("div", { class:"row" }, [ btnSmall("+ Fixa", "btnGreen", () => {
          const wrap = el("div");
          const form = el("div", { class:"form" });
          const iName = el("input", { placeholder:"Nome (ex: Condom√≠nio)" });
          const iVal = el("input", { placeholder:"Valor (ex: 250,00)" });
          form.appendChild(el("label", {}, ["Nome", iName]));
          form.appendChild(el("label", {}, ["Valor", iVal]));
          wrap.appendChild(form);

          const bCancel = btnSmall("Cancelar", "btnGhost", () => closeModal());
          const bSave = btnSmall("Adicionar", "btnGreen", () => {
            const nm = normDesc(iName.value);
            const v = numOr(iVal.value, NaN);
            if (!nm || !Number.isFinite(v)){ toast("Preencha nome e valor."); return; }
            data.fixed_templates.push({ name: nm, amount: Number(v) });
            ensureFixedDueForMonth(state.m, state.y);
            save();
            closeModal();
            toast("Despesa fixa adicionada.");
            render();
          });

          openModal("Nova despesa fixa", wrap, [bCancel, bSave]);
        }) ])
      ])
    );

    const body = el("div", { class:"panelBody" });

    body.appendChild(el("div", { class:"itemTitle" }, ["Modelos de fixas (Previsto)"]));
    const templates = data.fixed_templates || [];
    const listT = el("div", { class:"list" });

    if (!templates.length){
      listT.appendChild(el("div", { class:"item" }, [el("div", { class:"muted" }, ["Sem fixas cadastradas."])]));
    }else{
      templates.forEach((it) => {
        const item = el("div", { class:"item" });
        item.appendChild(el("div", { class:"itemTop" }, [
          el("div", {}, [
            el("p", { class:"itemTitle" }, [safeText(it.name)]),
            el("div", { class:"itemMeta mono" }, [`Previsto: ${brl(numOr(it.amount,0))}`])
          ])
        ]));
        listT.appendChild(item);
      });
    }

    body.appendChild(listT);

    body.appendChild(el("div", { class:"divider" }));
    body.appendChild(el("div", { class:"itemTitle" }, ["Fixas do m√™s (Realizado)"]));

    const fixedTxs = monthTransactions(state.m, state.y).filter(t => t.cat === "Despesas Fixas");
    const listM = el("div", { class:"list" });

    if (!fixedTxs.length){
      listM.appendChild(el("div", { class:"item" }, [el("div", { class:"muted" }, ["Sem lan√ßamentos de fixas neste m√™s."])]));
    }else{
      fixedTxs.forEach((t) => {
        const paid = t.paid === true;
        const paidTxt = paid ? "‚úÖ Pago" : "‚¨úÔ∏è Pagar";

        const item = el("div", { class:"item" });
        item.appendChild(el("div", { class:"itemTop" }, [
          el("div", {}, [
            el("p", { class:"itemTitle mono" }, [`${t.date} ‚Ä¢ ${brl(t.valor)}`]),
            el("div", { class:"itemMeta" }, [safeText(t.desc || "")])
          ]),
          el("div", { class:"row" }, [
            btnSmall(paidTxt, paid ? "btnDark" : "btnGhost", () => { t.paid = !paid; save(); render(); }),
            btnSmall("Excluir", "btnRed", () => {
              if (!confirm("Excluir esta fixa do m√™s?")) return;
              const idx = data.transactions.indexOf(t);
              if (idx >= 0) data.transactions.splice(idx, 1);
              save();
              toast("Exclu√≠da.");
              render();
            })
          ])
        ]));
        listM.appendChild(item);
      });
    }

    body.appendChild(listM);
    p.appendChild(body);
    return p;
  }

  function renderReceitas(){
    const p = el("div", { class:"panel" });

    p.appendChild(
      el("div", { class:"panelHeader" }, [
        el("div", {}, [
          el("div", { class:"panelTitle" }, ["üí∞ Receitas ‚Ä¢ ", monthYearStr(state.m, state.y)]),
          el("div", { class:"panelSub" }, ["Somente m√™s selecionado"])
        ]),
        btnSmall("+ Nova", "btnOrange", () => popupAddIncome("receitas"))
      ])
    );

    const body = el("div", { class:"panelBody" });

    const incs = (data.incomes || []).filter(it => {
      const d = parse_ddmmyyyy(it.date);
      if (!d) return false;
      return sameMonth(d, state.m, state.y);
    }).slice().reverse();

    const list = el("div", { class:"list" });

    if (!incs.length){
      list.appendChild(el("div", { class:"item" }, [el("div", { class:"muted" }, ["Sem receitas neste m√™s."])]));
    }else{
      incs.forEach((it) => {
        const item = el("div", { class:"item" });
        item.appendChild(el("div", { class:"itemTop" }, [
          el("div", {}, [
            el("p", { class:"itemTitle mono" }, [`${it.date} ‚Ä¢ ${safeText(it.source)} ‚Ä¢ ${brl(it.valor)}`]),
            el("div", { class:"itemMeta" }, [safeText(it.desc || "")])
          ]),
          el("div", { class:"row" }, [
            btnSmall("Excluir", "btnRed", () => {
              if (!confirm("Excluir esta receita?")) return;
              const idx = data.incomes.indexOf(it);
              if (idx >= 0) data.incomes.splice(idx, 1);
              save();
              toast("Receita exclu√≠da.");
              render();
            })
          ])
        ]));
        list.appendChild(item);
      });
    }

    body.appendChild(list);
    p.appendChild(body);
    return p;
  }

  function renderCartoes(){
    const p = el("div", { class:"panel" });

    p.appendChild(
      el("div", { class:"panelHeader" }, [
        el("div", {}, [
          el("div", { class:"panelTitle" }, ["üí≥ Cart√µes ‚Ä¢ ", monthYearStr(state.m, state.y)]),
          el("div", { class:"panelSub" }, ["Editar limites/metas do m√™s ‚Ä¢ ver Previsto x Realizado"])
        ]),
        el("div", { class:"row" }, [
          btnSmall("+ Cart√£o", "btnGreen", () => popupAddCard()),
          btnSmall("+ Gasto", "btnGhost", () => popupAddTransaction("cartoes"))
        ])
      ])
    );

    const body = el("div", { class:"panelBody" });
    const list = el("div", { class:"list" });

    const cards = data.cards || {};
    const entries = Object.entries(cards);

    if (!entries.length){
      list.appendChild(el("div", { class:"item" }, [el("div", { class:"muted" }, ["Sem cart√µes cadastrados."])]));
    }else{
      entries.forEach(([cardName, limitRaw]) => {
        const limit = numOr(limitRaw, 0);
        const spent = monthTotalForCard(cardName, state.m, state.y);
        const rest = limit - spent;
        const pct = limit > 0 ? Math.max(0, Math.min(100, (spent / limit) * 100)) : 0;

        const item = el("div", { class:"item" });
        item.appendChild(el("div", { class:"itemTop" }, [
          el("div", {}, [
            el("p", { class:"itemTitle" }, [cardName]),
            el("div", { class:"itemMeta mono" }, [`Previsto: ${brl(limit)} ‚Ä¢ Realizado: ${brl(spent)} ‚Ä¢ Restam: ${brl(rest)}`])
          ]),
          el("div", { class:"row" }, [
            btnSmall("Ver", "btnDark", () => go("card_detail", cardName)),
            btnSmall("Editar", "btnGhost", () => popupEditCard(cardName)),
            btnSmall("+ Gasto", "btnGreen", () => popupAddTransaction("card_detail", cardName)),
          ])
        ]));
        item.appendChild(el("div", { class:"progressWrap" }, [
          el("div", { class:"progressBar", style:`width:${pct}%;` })
        ]));
        list.appendChild(item);
      });
    }

    body.appendChild(list);
    p.appendChild(body);
    return p;
  }

  function renderCardDetail(cardName){
    const p = el("div", { class:"panel" });

    const limit = numOr((data.cards||{})[cardName], 0);
    const spent = monthTotalForCard(cardName, state.m, state.y);
    const rest = limit - spent;
    const pct = limit > 0 ? Math.max(0, Math.min(100, (spent / limit) * 100)) : 0;

    p.appendChild(
      el("div", { class:"panelHeader" }, [
        el("div", {}, [
          el("div", { class:"panelTitle" }, [`üí≥ ${cardName} ‚Ä¢ ${monthYearStr(state.m, state.y)}`]),
          el("div", { class:"panelSub" }, [`Previsto (limite): ${brl(limit)} ‚Ä¢ Realizado: ${brl(spent)} ‚Ä¢ Restam: ${brl(rest)}`])
        ]),
        el("div", { class:"row" }, [
          btnSmall("‚óÄ Voltar", "btnGhost", () => go("cartoes")),
          btnSmall("Editar limite", "btnGhost", () => popupEditCard(cardName)),
          btnSmall("+ Gasto", "btnGreen", () => popupAddTransaction("card_detail", cardName)),
        ])
      ])
    );

    const body = el("div", { class:"panelBody" });

    body.appendChild(el("div", { class:"kpi" }, [
      el("div", { class:"kpiCard" }, [
        el("div", { class:"label" }, ["Previsto (limite)"]),
        el("div", { class:"value mono" }, [brl(limit)])
      ]),
      el("div", { class:"kpiCard" }, [
        el("div", { class:"label" }, ["Realizado"]),
        el("div", { class:"value mono" }, [brl(spent)])
      ]),
      el("div", { class:"kpiCard" }, [
        el("div", { class:"label" }, ["Restante"]),
        el("div", { class:"value mono" }, [brl(rest)])
      ]),
    ]));

    body.appendChild(el("div", { class:"progressWrap" }, [
      el("div", { class:"progressBar", style:`width:${pct}%;` })
    ]));

    body.appendChild(el("div", { class:"divider" }));

    const txs = monthTransactionsForCard(cardName, state.m, state.y);
    if (!txs.length){
      body.appendChild(el("div", { class:"item" }, [el("div", { class:"muted" }, ["Sem compras nesse cart√£o no m√™s."])]));
      p.appendChild(body);
      return p;
    }

    const list = el("div", { class:"list" });

    txs.forEach((t) => {
      const paid = t.paid === true;
      const paidTxt = paid ? "‚úÖ Pago" : "‚¨úÔ∏è Pagar";

      const item = el("div", { class:"item" });
      item.appendChild(el("div", { class:"itemTop" }, [
        el("div", {}, [
          el("p", { class:"itemTitle mono" }, [`${t.date} ‚Ä¢ ${t.cat} ‚Ä¢ ${brl(t.valor)}`]),
          el("div", { class:"itemMeta" }, [safeText(t.desc || "")])
        ]),
        el("div", { class:"row" }, [
          btnSmall(paidTxt, paid ? "btnDark" : "btnGhost", () => { t.paid = !paid; save(); render(); }),
          btnSmall("Excluir", "btnRed", () => {
            if (!confirm("Excluir este gasto do cart√£o?")) return;
            const idx = data.transactions.indexOf(t);
            if (idx >= 0) data.transactions.splice(idx, 1);
            save();
            toast("Gasto exclu√≠do.");
            render();
          })
        ])
      ]));

      list.appendChild(item);
    });

    body.appendChild(list);
    p.appendChild(body);
    return p;
  }

  // ====== Inicial ======
  ensureFixedDueForMonth(state.m, state.y);
  save();
  setMonth(state.m, state.y);
  go("dashboard");
})();
</script>
</body>
</html>
